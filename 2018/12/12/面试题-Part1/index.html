<!DOCTYPE html><html class="appearance-auto" lang="zh-Hans"><head><meta charset="UTF-8"><title>面试题-内存篇</title><meta name="description" content="cfjia个人博客"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="generator" content="Hexo 5.0.2"></head><body class="is-flex is-flex-direction-column"><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-mobile"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">cfjia's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">面试题-内存篇</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%BD%BF%E7%94%A8weak%E5%85%B3%E9%94%AE%E5%AD%97%EF%BC%8C%E7%9B%B8%E6%AF%94assign%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E5%90%8C%EF%BC%9F"><span class="toc-text">1.什么情况使用weak关键字，相比assign有什么不同？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-weak%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9F"><span class="toc-text">2.weak的实现原理？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9F%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E7%9A%84%EF%BC%9F"><span class="toc-text">3.关联对象的应用？系统如何实现关联对象的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9F%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0weak%E5%B1%9E%E6%80%A7"><span class="toc-text">4.关联对象如何进行内存管理？关联对象如何实现weak属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Autoreleasepool%E7%9A%84%E5%8E%9F%E7%90%86%EF%BC%9F%E6%89%80%E4%BD%BF%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%98%AF%E4%BB%80%E4%B9%88-%EF%BC%9F"><span class="toc-text">5.Autoreleasepool的原理？所使用的数据结构是什么 ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-ARC%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9FARC%E4%B8%8B%E5%AF%B9%E4%BF%9D%E7%95%99%EF%BC%8C%E9%87%8A%E6%94%BE%E5%B7%B2%E8%BF%9B%E8%A1%8C%E4%BA%86%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96"><span class="toc-text">6.ARC的实现原理？ARC下对保留，释放已进行了一些优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-ARC%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BC%9A%E9%80%A0%E6%88%90%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%EF%BC%9F"><span class="toc-text">7.ARC什么情况下会造成内存泄漏？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-iOS%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA%E6%83%85%E5%86%B5"><span class="toc-text">8.iOS内存分区情况</span></a></li></ol></div><div class="column is-9"><header class="my-4"></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">面试题-内存篇</h1><time class="has-text-grey" datetime="2018-12-11T16:00:00.000Z">2018-12-12</time><article class="mt-2 post-content"><h3 id="1-什么情况使用weak关键字，相比assign有什么不同？"><a href="#1-什么情况使用weak关键字，相比assign有什么不同？" class="headerlink" title="1.什么情况使用weak关键字，相比assign有什么不同？"></a>1.什么情况使用weak关键字，相比assign有什么不同？</h3><ul>
<li><p>在ARC中，在有可能出现循环引用的时候，往往要通过让其中一端使用weak来解决，比如:delegate,block。</p>
</li>
<li><p>自身已经对它进行一次强引用，没有必要再强引用一次,此时也会使用weak。</p>
</li>
<li><p>自定义IBOutlet控件属性一般也使用weak，当然也可以使用strong</p>
<p>不同点:</p>
<ul>
<li>weak 此特质表明该属性定义了一种”非拥有关系”。为这种属性设置新值时，设置方法既不保留新值，也不释放旧值。此特质同assign类似，然而在属性所指的对象遭到销毁时，属性值也会清空。而assign的”设置方法”只会执行针对”纯量类型”(scalar type，例如 CGFloat或 NSInteger等)的简单赋值操作</li>
<li>assign可以用非OC对象，weak必须用于OC对象</li>
</ul>
</li>
</ul>
<h3 id="2-weak的实现原理？"><a href="#2-weak的实现原理？" class="headerlink" title="2.weak的实现原理？"></a>2.weak的实现原理？</h3><p>Runtime对注册的类，会进行布局，对于weak对象会放入一个hash表中。用weak指向的对象内存地址作为key，当此对象的引用计数为0的时候会dealloc，假如weak指向的内存地址为a，那么就会以a为键，在这个weak表中搜索，找到所有以a为键的weak对象，从而设置为nil。</p>
<h3 id="3-关联对象的应用？系统如何实现关联对象的？"><a href="#3-关联对象的应用？系统如何实现关联对象的？" class="headerlink" title="3.关联对象的应用？系统如何实现关联对象的？"></a>3.关联对象的应用？系统如何实现关联对象的？</h3><p>分类与关联对象是OC的扩展机制的两个特性，分类：可以通过它扩展方法；关联对象，可以通过它来扩展属性。<br>在iOS开发中，可能category比较常见，相对的关联属性就用的较少，要用它之前，需要先导入runtime头文件</p>
<p>如何关联对象<br> runtime提供了给我们三个API进行管理关联对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关联对象</span></span><br><span class="line"><span class="keyword">void</span> objc_setAssociatedObject(id object, <span class="keyword">const</span> <span class="keyword">void</span> *key, id value, objc_AssociationPolicy policy)</span><br><span class="line"><span class="comment">//获取关联的对象</span></span><br><span class="line">id objc_getAssociatedObject(id object, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span><br><span class="line"><span class="comment">//移除关联的对象</span></span><br><span class="line"><span class="keyword">void</span> objc_removeAssociatedObjects(id object)</span><br></pre></td></tr></table></figure>

<p>其中的参数</p>
<ul>
<li><code>id object</code>：被关联的对象</li>
<li><code>const void *key</code>：关联的key，要求唯一</li>
<li><code>id value</code>：关联的对象</li>
<li><code>objc_AssociationPolicy policy</code>：内存管理的策略 </li>
</ul>
<p>关系对象的应用</p>
<ul>
<li>为分类添加属性</li>
<li>为UI控件关联事件Block（Alert添加回调事件Block）</li>
<li>关联观察者对象（AFNetworking为菊花控件监听NSURLSessionTask以获取网络进度的分类）</li>
</ul>
<h3 id="4-关联对象如何进行内存管理？关联对象如何实现weak属性"><a href="#4-关联对象如何进行内存管理？关联对象如何实现weak属性" class="headerlink" title="4.关联对象如何进行内存管理？关联对象如何实现weak属性"></a>4.关联对象如何进行内存管理？关联对象如何实现weak属性</h3><ul>
<li><p>关联对象的ObjectAssociation中有objc_AssociationPolicy该属性，内存管理策略，包含多个枚举(retain，assgin，copy等)，会对对应的对象进行和普通对象一样的内存管理操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,           <span class="comment">/**&lt; Specifies a weak reference to the associated object. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, <span class="comment">/**&lt; Specifies a strong reference to the associated object. </span></span><br><span class="line"><span class="comment">                                            *   The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,   <span class="comment">/**&lt; Specifies that the associated object is copied. </span></span><br><span class="line"><span class="comment">                                            *   The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,       <span class="comment">/**&lt; Specifies a strong reference to the associated object.</span></span><br><span class="line"><span class="comment">                                            *   The association is made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span>          <span class="comment">/**&lt; Specifies that the associated object is copied.</span></span><br><span class="line"><span class="comment">                                            *   The association is made atomically. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联对象实现weak，可用__weak修饰对象，并将其用block包裹，关联该block对象；或者生命一个类，持有一个weak的成员变量，然后通过实例化我们自定义的class实例，然后把这个实例作为关联对象即可。</p>
</li>
</ul>
<h3 id="5-Autoreleasepool的原理？所使用的数据结构是什么-？"><a href="#5-Autoreleasepool的原理？所使用的数据结构是什么-？" class="headerlink" title="5.Autoreleasepool的原理？所使用的数据结构是什么 ？"></a>5.Autoreleasepool的原理？所使用的数据结构是什么 ？</h3><p>动释放池是有N张<code>AutoreleasePoolPage</code>组成,每张page 4K大小, AutoreleasePoolPage是<a target="_blank" rel="noopener" href="https://www.wangt.cc/tag/c/">c++</a>的类, AutoreleasePoolPage以双向链表连接起来形成一个自动释放池。编译后，autoreleasepool是一个全局变量，每一个线程，在runloop启动时都会准备一个autoreleasepool，主要是两个方法，push，pop。<br>push就是在page中插入一个哨兵对象,代表这些属于要一起release的对象,如果page满了,则创建新的page,并合老的page关联起来,对象指针压栈<br>pop就是从传入哨兵对象往后,所有对象,依次执行release。</p>
<p>autoreleasepool的作用：释放临时变量缓解内存高涨</p>
<p>autoreleasepool什么时候创建？什么时候销毁？</p>
<ul>
<li>第一次创建：启动<code>runloop</code>时</li>
<li>最后一次销毁：<code>runloop</code>退出时</li>
<li>其他时候的创建和销毁：当<code>runloop</code>即将进行<code>休眠状态</code>时会销毁旧的释放池，并创建一个新的释放池。</li>
</ul>
<p>runloop运行结束时，会倾倒autoreleasepool，并对pool里的每一个对象发送一个release消息；然后autoreleasepool被drain 销毁</p>
<h3 id="6-ARC的实现原理？ARC下对保留，释放已进行了一些优化"><a href="#6-ARC的实现原理？ARC下对保留，释放已进行了一些优化" class="headerlink" title="6.ARC的实现原理？ARC下对保留，释放已进行了一些优化"></a>6.ARC的实现原理？ARC下对保留，释放已进行了一些优化</h3><p>ARC自动引用计数，是苹果objc4日期的编译器自动在适当位置帮助实例对象进行自动保留其他释放的一套机制。它的实现原理就是在编译扩展插入相关代码，帮助补全MRC时代需要开发者手动填充的和管理的对象的相关内存操作的方法。为了解释清楚具体实现原理，从代码编译成汇编过程中编译器做了很多优化工作。更新<code>isa指针</code>的信息。</p>
<h3 id="7-ARC什么情况下会造成内存泄漏？"><a href="#7-ARC什么情况下会造成内存泄漏？" class="headerlink" title="7.ARC什么情况下会造成内存泄漏？"></a>7.ARC什么情况下会造成内存泄漏？</h3><ul>
<li>block的循环引用</li>
<li>NSTimer的循环引用</li>
<li>addObserver的循环引用</li>
<li>delegate的强引用</li>
<li>大次数循环内存暴涨</li>
<li>非oc对象的内存处理（需手动释放）</li>
</ul>
<h3 id="8-iOS内存分区情况"><a href="#8-iOS内存分区情况" class="headerlink" title="8.iOS内存分区情况"></a>8.iOS内存分区情况</h3><ul>
<li><p>栈区 </p>
<p>存放临时创建的局部变量、先进后出、一旦出了作用域就会被销毁；函数跳转地址，现场保护等； 程序猿不需要管理栈区变量的内存（栈区地址从高到低分配）</p>
</li>
<li><p>堆区</p>
<p>堆区的内存分配使用的是alloc，调用malloc函数，新分配的内存动态添加到堆上<br> 需要程序猿管理内存；ARC的内存的管理，是编译器在编译的时候自动添加 retain、release、autorelease；（堆区的地址是从低到高分配）</p>
</li>
<li><p>全局区/静态区</p>
<p>包括两个部分：未初始化过 、初始化过。也就是说，（全局区／静态区）在内存中是放在一起的，初始化的全局变量和静态变量在一块区域， 未初始化的全局变量和未初始化的静态变量在相邻的另一块区域；<br> eg：int a;未初始化的。int a = 10;已初始化的。</p>
</li>
<li><p>常量区</p>
<p>常量字符串就是放在这里</p>
</li>
<li><p>代码区</p>
<p>存放app代码</p>
</li>
</ul>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2018/12/12/Untitled/" title="面试题-消息传递"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: 面试题-消息传递</span></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com//Jostr-szq"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com//J.Random"><i class="iconfont icon-zhihu"></i></a><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> cfjia 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>